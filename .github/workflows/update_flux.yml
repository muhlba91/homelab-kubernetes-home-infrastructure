---
name: Update Flux

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    name: Check for Update
    strategy:
      max-parallel: 12
      matrix:
        site:
          - vie

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: fluxcd/flux2/action@6c58ea576e72ef45487f63ec1c902260d4ed3d81 # main

      - id: update
        run: |
          flux install \
            --components source-controller,kustomize-controller,helm-controller,notification-controller \
            --cluster-domain cluster.local \
            --export > ./cluster-bootstrap/${{ matrix.site }}/flux-system/gotk-components.yaml

          VERSION="$(flux -v)"
          echo "flux_version=$VERSION" >> $GITHUB_OUTPUT

      - uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          branch: chore/update-flux
          delete-branch: true
          commit-message: "chore(deps): update flux to ${{ steps.update.outputs.flux_version }}"
          title: "[Flux] Update Flux to ${{ steps.update.outputs.flux_version }}"
          body: |
            Updates Flux to ${{ steps.update.outputs.flux_version }}.

            Changelog: https://github.com/fluxcd/flux2/releases/tag/${{ steps.update.outputs.flux_version }}
          committer: GitHub <noreply@github.com>
          author: ${{ github.action }} <${{ github.action }}+github-actions[bot]@users.noreply.github.com>
