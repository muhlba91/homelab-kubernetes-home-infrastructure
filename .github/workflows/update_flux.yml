---
name: Update Flux

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    name: Check for Update
    strategy:
      max-parallel: 12
      matrix:
        site:
          - vie

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: fluxcd/flux2/action@d6dec730d8c3ea5dffdcfb195ca3bee453ce82d4 # main

      - id: update
        run: |
          flux install \
            --components source-controller,kustomize-controller,helm-controller,notification-controller \
            --cluster-domain cluster.local \
            --export > ./cluster-bootstrap/${{ matrix.site }}/flux-system/gotk-components.yaml

          VERSION="$(flux -v)"
          echo "flux_version=$VERSION" >> $GITHUB_OUTPUT

      - uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          branch: chore/update-flux
          delete-branch: true
          commit-message: "chore(deps): update flux to ${{ steps.update.outputs.flux_version }}"
          title: "[Flux] Update Flux to ${{ steps.update.outputs.flux_version }}"
          body: |
            Updates Flux to ${{ steps.update.outputs.flux_version }}.

            Changelog: https://github.com/fluxcd/flux2/releases/tag/${{ steps.update.outputs.flux_version }}
          committer: GitHub <noreply@github.com>
          author: ${{ github.action }} <${{ github.action }}+github-actions[bot]@users.noreply.github.com>
